<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Caminho Fácil – Mapa</title>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
		<link rel="stylesheet" href="assets/css/style.css" />

		<style>
			html,
			body {
				height: 100%;
				margin: 0;
			}
			#map {
				height: calc(100vh - 140px);
				border-radius: 10px;
			}
			.navbar {
				z-index: 1000;
			}
		</style>
	</head>

	<body class="bg-light">
		<!-- Barra superior -->
		<nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top">
			<div class="container-fluid">
				<a class="navbar-brand fw-bold" href="index.html">Caminho Fácil</a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item"><a class="nav-link" href="rotas.html">Rotas</a></li>
						<li class="nav-item"><a class="nav-link" href="relatorio.html">Relatório</a></li>
						<li class="nav-item"><a class="nav-link" href="login.html">Usuário</a></li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- Conteúdo principal -->
		<div class="container mt-4 pt-3">
			<div class="text-center mb-2">
				<img src="assets/img/logo.png" alt="Caminho Fácil" style="height: 60px" class="mb-3" />
			</div>

			<!-- Campo de busca -->
			<div class="input-group mb-3">
				<input type="text" id="campoBusca" class="form-control" placeholder="Digite o nome da rua..." />
				<button id="botaoBusca" class="btn btn-success">Buscar</button>
			</div>

			<div id="map"></div>

			<div class="text-center my-3">
				<a href="detalhes.html" id="botaoDetalhes" class="btn btn-primary btn-lg"> Ver detalhes da rua selecionada </a>
			</div>
		</div>

		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			// --- Inicialização do mapa ---
			const map = L.map("map").setView([-23.55, -46.63], 13);

			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution: "&copy; OpenStreetMap contributors",
				maxZoom: 19,
			}).addTo(map);

			let marcadorUsuario = null;
			let marcadorClique = null;
			let marcadorBusca = null;

			// --- Localização automática ---
			function localizarUsuario() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(
						(pos) => {
							const { latitude, longitude } = pos.coords;
							if (!marcadorUsuario) {
								marcadorUsuario = L.marker([latitude, longitude]).addTo(map).bindPopup("Você está aqui!").openPopup();
							} else {
								marcadorUsuario.setLatLng([latitude, longitude]);
							}
							map.setView([latitude, longitude], 16);
						},
						(err) => console.warn("Erro ao obter localização:", err.message),
						{ enableHighAccuracy: true, timeout: 10000 }
					);
				}
			}
			localizarUsuario();

			// --- Ruas simuladas ---
			const ruas = [
				{ nome: "Rua XV de Novembro", coords: [-23.5489, -46.6388], nota: 4.2 },
				{ nome: "Rua Augusta", coords: [-23.5552, -46.6627], nota: 3.8 },
				{ nome: "Av. Paulista", coords: [-23.5614, -46.6559], nota: 4.6 },
			];

			// Função auxiliar para salvar a última rua clicada
			function salvarRuaSelecionada(nomeRua) {
				localStorage.setItem("ruaSelecionada", nomeRua);
			}

			// Adiciona marcadores fixos
			ruas.forEach((r) => {
				const url = new URL("detalhes.html", window.location.href);
				url.searchParams.set("rua", r.nome);
				const link = `<a href="${url.toString()}" onclick="salvarRuaSelecionada('${r.nome}')">Ver detalhes</a>`;
				L.marker(r.coords).addTo(map).bindPopup(`<b>${r.nome}</b><br>Avaliação média: ${r.nota}<br>${link}`);
			});

			// --- Clique no mapa ---
			map.on("click", async (e) => {
				const { lat, lng } = e.latlng;
				if (marcadorClique) map.removeLayer(marcadorClique);

				marcadorClique = L.marker([lat, lng]).addTo(map);

				try {
					const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
					const resp = await fetch(url);
					const data = await resp.json();

					let nomeRua = "Local desconhecido";
					if (data && data.address) {
						nomeRua = data.address.road || data.display_name || "Ponto sem nome";
					}

					salvarRuaSelecionada(nomeRua);
					marcadorClique.bindPopup(`<b>${nomeRua}</b><br><a href="detalhes.html?rua=${encodeURIComponent(nomeRua)}" onclick="salvarRuaSelecionada('${nomeRua}')">Ver detalhes</a>`).openPopup();
				} catch (err) {
					console.error("Erro ao buscar nome da rua:", err);
					marcadorClique.bindPopup("Erro ao identificar o local.").openPopup();
				}
			});

			// --- Busca manual ---
			const campoBusca = document.getElementById("campoBusca");
			const botaoBusca = document.getElementById("botaoBusca");

			botaoBusca.addEventListener("click", async () => {
				const rua = campoBusca.value.trim();
				if (!rua) {
					alert("Digite o nome de uma rua!");
					return;
				}

				try {
					const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(rua)}+São Paulo,Brasil`;
					const resp = await fetch(url);
					const dados = await resp.json();

					if (dados.length === 0) {
						alert("Rua não encontrada.");
						return;
					}

					const { lat, lon, display_name } = dados[0];
					if (marcadorBusca) map.removeLayer(marcadorBusca);

					salvarRuaSelecionada(display_name);

					marcadorBusca = L.marker([lat, lon])
						.addTo(map)
						.bindPopup(`<b>${display_name}</b><br><a href="detalhes.html?rua=${encodeURIComponent(display_name)}" onclick="salvarRuaSelecionada('${display_name}')">Ver detalhes</a>`)
						.openPopup();

					map.setView([lat, lon], 17);
				} catch (e) {
					console.error("Erro na busca:", e);
					alert("Erro ao buscar a rua. Tente novamente.");
				}
			});

			campoBusca.addEventListener("keypress", (e) => {
				if (e.key === "Enter") botaoBusca.click();
			});

			// --- Botão inferior “Ver detalhes da rua selecionada” ---
			const botaoDetalhes = document.getElementById("botaoDetalhes");
			botaoDetalhes.addEventListener("click", (e) => {
				const rua = localStorage.getItem("ruaSelecionada");
				if (rua) {
					e.preventDefault();
					window.location.href = `detalhes.html?rua=${encodeURIComponent(rua)}`;
				}
			});
		</script>
	</body>
</html>
