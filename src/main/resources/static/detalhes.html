<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Caminho Fácil - Detalhes</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="assets/css/additional_styles.css">

		<style>
			body {
				background-color: #f8f9fa;
			}

			.rating-display {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
				font-size: 1.4rem;
			}

			.star {
				color: gold;
				font-size: 1.6rem;
			}

			.progress {
				height: 12px;
			}

			.criterio {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.criterio label {
				font-weight: 500;
				margin-right: 10px;
			}

			.comentario {
				background: white;
				border-radius: 10px;
				padding: 10px 15px;
				margin-bottom: 10px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}

			.comentario strong {
				color: #198754;
			}

			.logoBox {
				background-color: white;
				border-radius: 0 8px 8px 0;
				padding: 5px 10px;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
				display: inline-block;
			}

			.logoImg {
				height: 30px;
				display: block;
			}

			.navbar {
				padding-top: 0.5rem;
				padding-bottom: 0.5rem;
			}

		</style>
	</head>
	<link rel="icon" type="image/png" href="assets/img/favicon.png" />

	<body class="bg-light">
		<!-- Navbar -->
		<nav class="navbar navbar-dark bg-success fixed-top position-relative">
			<div class="container-fluid d-flex align-items-center justify-content-between">
				<a class="navbar-brand text-white ms-5" href="index.html" id="botao_voltar">← Voltar</a>
				<span class="navbar-text text-white me-3">Detalhes Calçada</span>
			</div>

			<div class="logoBox position-absolute" style="top: 100%; left: 0; transform: translateY(-40%); z-index: 1">
				<img class="logoImg" src="assets/img/logoCF.png" alt="Logo Caminho Fácil" />
			</div>
		</nav>

		<!-- Conteúdo -->
		<h3 class="funcionalidade_titulo">
			<img src="assets/img/detalhes.png" class="icone_titulo">
			Detalhes calçada
			<button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="tooltip" data-bs-placement="right" 
					title="Informações sobre a calçada selecionada. Incluindo avaliações e comentários." id="info_button">i
			</button>
		</h3>
		<hr class="hr_style">
		<div class="container mt-5 pt-4" id="dados-rua">
			<h4 id="titulo-rua" class="my-3 text-center">Rua selecionada</h4>
			<div class="text-center mb-3">
				<button id="btnRota" class="btn btn-outline-success">
					<img src="assets/img/walk.png" style="height: 20px; padding-bottom: 2px;">
					Traçar rota
				</button>
			</div>

			<!-- Avaliação média -->
			<div class="card p-3 mb-4 shadow-sm">
				<h6 class="text-success mb-2">
					Avaliação média
					<button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="tooltip" data-bs-placement="right" 
					title="Média geral de todas as avaliações feitas sobre a calçada selecionada." id="info_button">i
					</button>
				</h6>
				<div class="rating-display" id="media-geral">
					<span id="stars">☆☆☆☆☆</span>
					<span id="valor-media">(N/A)</span>
				</div>
				<div class="text-center mt-2">
					<a href="avaliacao.html" class="btn btn-success btn-sm rounded-pill"> + Fazer avaliação </a>
				</div>
			</div>

			<!-- Características de acessibilidade -->
			<div class="card p-3 mb-4 shadow-sm">
				<h6 class="text-success">
					Características de acessibilidade
					<button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="tooltip" data-bs-placement="right" 
					title="Nível de qualidade de diferentes aspectos de acessabilidade da calçada selecionada" id="info_button">i
					</button>
				</h6>

				<div id="piso" class="criterio mt-2"><label>Piso tátil presente</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-success" style="width: 0%"></div>
				</div>

				<div id="rebaixamento" class="criterio"><label>Rebaixamento de guia</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-warning" style="width: 0%"></div>
				</div>

				<div id="iluminacao" class="criterio"><label>Iluminação noturna</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-info" style="width: 0%"></div>
				</div>

				<div id="livre" class="criterio"><label>Calçada livre de obstáculos</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-danger" style="width: 0%"></div>
				</div>

				<div id="idoso" class="criterio"><label>Adequada para idosos</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-primary" style="width: 0%"></div>
				</div>

				<div id="cadeirante" class="criterio"><label>Adequada para cadeirantes</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-secondary" style="width: 0%"></div>
				</div>

				<div id="carrinho" class="criterio"><label>Adequada para carrinhos de bebê</label><span>0%</span></div>
				<div class="progress">
					<div class="progress-bar bg-dark" style="width: 0%"></div>
				</div>
			</div>

			<!-- Comentários -->
			<div class="card p-3 shadow-sm mb-5" id="comentarios">
				<h6 class="text-success">Comentários</h6>				
				<p class="text-muted">Nenhum comentário ainda.</p>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			document.addEventListener("DOMContentLoaded", async () => {
				const params = new URLSearchParams(window.location.search);
				const ruaParam = params.get("rua"); // vem de detalhes.html?rua=...
				const ruaDec = ruaParam ? decodeURIComponent(ruaParam) : null;

				const titulo = document.getElementById("titulo-rua");
				const btnRota = document.getElementById("btnRota");

				// 1) Título e fallback de localStorage imediatamente
				titulo.textContent = ruaDec || "Rua não informada";
				if (ruaDec) localStorage.setItem("ruaSelecionada", ruaDec);

				// 2) Botão de rota SEMPRE funcional (independente das APIs)
				btnRota.addEventListener("click", () => {
					const destino = ruaDec ? `rotas.html?rua=${encodeURIComponent(ruaDec)}` : "rotas.html";
					window.location.href = destino;
				});

				try {
					// 3) Busca calçada (se falhar, seguimos com o fallback acima)
					const respCalc = await fetch(`/api/calcadas?rua=${encodeURIComponent(ruaDec || "")}`);
					if (respCalc.ok) {
						const calcadas = await respCalc.json();
						if (Array.isArray(calcadas) && calcadas.length > 0) {
							const c = calcadas[0];

							// salva coordenadas quando disponíveis (rotas.html pode usar)
							if (c.nome_rua) localStorage.setItem("ruaSelecionada", c.nome_rua);
							if (c.latitude_ini != null) localStorage.setItem("latIni", c.latitude_ini);
							if (c.longitude_ini != null) localStorage.setItem("lonIni", c.longitude_ini);
							if (c.latitude_fim != null) localStorage.setItem("latFim", c.latitude_fim);
							if (c.longitude_fim != null) localStorage.setItem("lonFim", c.longitude_fim);

							// 4) Busca resumo (pode não existir; não dá throw)
							const respResumo = await fetch(`/api/avaliacoes/resumo?calcadaId=${c.id}`);
							if (respResumo.ok) {
								const resumo = (await respResumo.json()) || {};

								// Avaliação média + estrelas
								const media = resumo.mediaGeral || 0;
								document.getElementById("valor-media").textContent = `(${media > 0 ? media.toFixed(1) : "N/A"})`;
								const stars = Math.floor(media);
								document.getElementById("stars").textContent = "★★★★★".slice(0, stars) + "☆☆☆☆☆".slice(0, 5 - stars);

								// Barras de características
								const setProgress = (id, valor = 0) => {
									const bar = document.querySelector(`#${id} + .progress .progress-bar`);
									const label = document.querySelector(`#${id} span`);
									if (bar && label) {
										bar.style.width = `${valor}%`;
										label.textContent = `${valor}%`;
									}
								};
								setProgress("piso", resumo.pisoTatil || 0);
								setProgress("rebaixamento", resumo.rebaixamentoGuia || 0);
								setProgress("iluminacao", resumo.iluminacaoNoturna || 0);
								setProgress("livre", resumo.semObstaculos || 0);
								setProgress("idoso", resumo.idoso || 0);
								setProgress("cadeirante", resumo.cadeirante || 0);
								setProgress("carrinho", resumo.carrinho || 0);

								// Comentários
								const comentariosDiv = document.getElementById("comentarios");
								const comentarios = Array.isArray(resumo.comentarios) ? resumo.comentarios : [];
								comentariosDiv.innerHTML =
									"<h6 class='text-success'>Comentários</h6>" + (comentarios.length ? comentarios.map((c) => `<div class="comentario"><strong>Usuário:</strong> ${c}</div>`).join("") : "<p class='text-muted'>Nenhum comentário ainda.</p>");
							}
						}
					}
					// Se qualquer etapa acima falhar, seguimos com N/A e o botão já está funcional
				} catch (err) {
					console.warn("Aviso:", err?.message || err);
					document.querySelector("#valor-media").textContent = "(N/A)";
					document.querySelector("#comentarios").innerHTML = "<h6 class='text-success'>Comentários</h6><p class='text-muted'>Nenhum dado cadastrado para esta rua.</p>";
				}
			});
		</script>
	</body>
</html>
