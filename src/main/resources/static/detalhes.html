<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Caminho F√°cil - Detalhes</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

		<style>
			body {
				background-color: #f8f9fa;
			}

			.rating-display {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
				font-size: 1.4rem;
			}

			.star {
				color: gold;
				font-size: 1.6rem;
			}

			.progress {
				height: 12px;
			}

			.criterio {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.criterio label {
				font-weight: 500;
				margin-right: 10px;
			}

			.foto-rua {
				border-radius: 10px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.comentario {
				background: white;
				border-radius: 10px;
				padding: 10px 15px;
				margin-bottom: 10px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}

			.comentario strong {
				color: #198754;
			}

			.btn-outline-success {
				border-radius: 20px;
			}

			h6 {
				margin-top: 20px;
				font-weight: 600;
			}
		</style>
	</head>

	<body class="bg-light">
		<!-- Navbar -->
		<nav class="navbar navbar-dark bg-success fixed-top">
			<div class="container-fluid">
				<a class="navbar-brand" href="index.html">‚Üê Voltar</a>
				<span class="navbar-text text-white">Detalhes da Rua</span>
			</div>
		</nav>

		<!-- Conte√∫do -->
		<div class="container mt-5 pt-4" id="dados-rua">
			<h4 id="titulo-rua" class="my-3 text-center">Rua selecionada</h4>

			<div class="text-center mb-3">
				<button id="btnRota" class="btn btn-outline-success">üö∂ Tra√ßar rota</button>
			</div>

			<!-- Avalia√ß√£o m√©dia -->
			<div class="card p-3 mb-4 shadow-sm">
				<h6 class="text-success mb-2">Avalia√ß√£o m√©dia</h6>
				<div class="rating-display" id="media-geral">
					<span id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
					<span id="valor-media">(N/A)</span>
				</div>
				<div class="text-center mt-2">
					<a href="avaliacao.html" class="btn btn-success btn-sm rounded-pill"> + Fazer avalia√ß√£o </a>
				</div>
			</div>

			<!-- Caracter√≠sticas de acessibilidade -->
			<div class="card p-3 mb-4 shadow-sm">
				<h6 class="text-success">Caracter√≠sticas de acessibilidade</h6>

				<div id="piso" class="criterio mt-2"><label>Piso t√°til presente</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-success" style="width: 0%"></div>
				</div>

				<div id="rebaixamento" class="criterio"><label>Rebaixamento de guia</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-warning" style="width: 0%"></div>
				</div>

				<div id="iluminacao" class="criterio"><label>Ilumina√ß√£o adequada</label><span>0%</span></div>
				<div class="progress mb-2">
					<div class="progress-bar bg-info" style="width: 0%"></div>
				</div>

				<div id="livre" class="criterio"><label>Cal√ßada livre de obst√°culos</label><span>0%</span></div>
				<div class="progress">
					<div class="progress-bar bg-danger" style="width: 0%"></div>
				</div>
			</div>

			<!-- Coment√°rios -->
			<div class="card p-3 shadow-sm mb-5" id="comentarios">
				<h6 class="text-success">Coment√°rios</h6>
				<p class="text-muted">Nenhum coment√°rio ainda.</p>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			document.addEventListener("DOMContentLoaded", async () => {
				const params = new URLSearchParams(window.location.search);
				const rua = params.get("rua");
				const titulo = document.getElementById("titulo-rua");
				const btnRota = document.getElementById("btnRota");

				if (rua) titulo.textContent = decodeURIComponent(rua);
				else titulo.textContent = "Rua n√£o informada";

				try {
					// 1Ô∏è‚É£ Buscar cal√ßada correspondente √† rua
					const respCalc = await fetch(`/api/calcadas?rua=${encodeURIComponent(rua)}`);
					if (!respCalc.ok) throw new Error("Erro ao buscar cal√ßadas");
					const calcadas = await respCalc.json();
					if (!calcadas.length) throw new Error("Nenhuma cal√ßada encontrada");

					const calcadaId = calcadas[0].id;

					// 2Ô∏è‚É£ Buscar resumo de avalia√ß√µes
					const respResumo = await fetch(`/api/avaliacoes/resumo?calcadaId=${calcadaId}`);
					if (!respResumo.ok) throw new Error("Erro ao buscar resumo");
					const resumo = await respResumo.json();

					// Se n√£o houver avalia√ß√µes, exibe mensagem sutil
					if (!resumo || Object.keys(resumo).length === 0) {
						document.querySelector("#valor-media").textContent = "(N/A)";
						document.querySelector("#comentarios").innerHTML = "<h6 class='text-success'>Coment√°rios</h6><p class='text-muted'>Nenhum dado cadastrado para esta rua.</p>";
						return;
					}

					// 3Ô∏è‚É£ Avalia√ß√£o m√©dia e estrelas
					const valorMedia = document.getElementById("valor-media");
					const starsContainer = document.getElementById("stars");
					const media = resumo.mediaGeral || 0;
					valorMedia.textContent = `(${media > 0 ? media.toFixed(1) : "N/A"})`;

					const fullStars = Math.floor(media);
					const halfStar = media % 1 >= 0.5;
					let starsHTML = "";
					for (let i = 0; i < 5; i++) {
						if (i < fullStars) starsHTML += "‚òÖ";
						else if (i === fullStars && halfStar) starsHTML += "‚òÜ";
						else starsHTML += "‚òÜ";
					}
					starsContainer.textContent = starsHTML;

					// 4Ô∏è‚É£ Percentuais
					const setProgress = (id, valor) => {
						const bar = document.querySelector(`#${id} + .progress .progress-bar`);
						const label = document.querySelector(`#${id} span`);
						if (bar && label) {
							bar.style.width = valor + "%";
							label.textContent = valor + "%";
						}
					};

					setProgress("piso", resumo.pisoTatil || 0);
					setProgress("rebaixamento", resumo.rebaixamentoGuia || 0);
					setProgress("iluminacao", resumo.iluminacaoNoturna || 0);
					setProgress("livre", resumo.semObstaculos || 0);

					// 5Ô∏è‚É£ Coment√°rios
					const comentariosDiv = document.getElementById("comentarios");
					if (resumo.comentarios && resumo.comentarios.length > 0) {
						comentariosDiv.innerHTML = "<h6 class='text-success'>Coment√°rios</h6>" + resumo.comentarios.map((c) => `<div class="comentario"><strong>Usu√°rio:</strong> ${c}</div>`).join("");
					} else {
						comentariosDiv.innerHTML = "<h6 class='text-success'>Coment√°rios</h6><p class='text-muted'>Nenhum coment√°rio ainda.</p>";
					}

					// 6Ô∏è‚É£ Bot√£o "Tra√ßar rota"
					btnRota.addEventListener("click", () => {
						window.location.href = `rotas.html?rua=${encodeURIComponent(rua)}`;
					});
				} catch (err) {
					console.warn("Aviso:", err.message);
					document.querySelector("#valor-media").textContent = "(N/A)";
					document.querySelector("#comentarios").innerHTML = "<h6 class='text-success'>Coment√°rios</h6><p class='text-muted'>Nenhum dado cadastrado para esta rua.</p>";
				}
			});
		</script>
	</body>
</html>
