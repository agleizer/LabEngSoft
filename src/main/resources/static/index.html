<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Caminho F√°cil ‚Äì Mapa</title>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

		<style>
			html,
			body {
				height: 100%;
				margin: 0;
			}
			#map {
				height: 100vh;
				width: 100vw;
			}

			/* --- elementos flutuantes --- */
			/* --- caixa de busca (desktop) --- */
			.search-box {
				position: absolute;
				top: 15px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 1000;
				width: 90%;
				max-width: 500px;
				background: white;
				border-radius: 8px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
				display: flex;
			}

			/* --- ajustes para mobile --- */
			@media (max-width: 768px) {
				.search-box {
					top: 65px; /* afasta da borda superior, abaixo dos √≠cones */
					left: 5%;
					transform: none;
					width: 90%;
					max-width: none;
					border-radius: 6px;
				}

				.search-box input {
					padding: 8px;
					font-size: 14px;
				}

				.search-box button {
					padding: 0 10px;
					font-size: 14px;
				}

				/* afasta controles de zoom do Leaflet do campo de busca */
				.leaflet-top.leaflet-left {
					top: 140px; /* move os bot√µes + e - um pouco para baixo */
				}
			}

			.search-box input {
				border: none;
				padding: 10px;
				flex: 1;
				border-radius: 8px 0 0 8px;
			}

			.search-box button {
				border: none;
				background: #198754;
				color: white;
				padding: 0 15px;
				border-radius: 0 8px 8px 0;
			}

			.top-icons {
				position: absolute;
				top: 15px;
				right: 15px;
				z-index: 1000;
				display: flex;
				gap: 10px;
			}

			.top-icons button {
				border: none;
				background: white;
				border-radius: 50%;
				width: 42px;
				height: 42px;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
			}

			/* --- sidebar lateral --- */
			#sidebar {
				position: fixed;
				left: -250px;
				top: 0;
				height: 100%;
				width: 250px;
				background: #198754;
				color: white;
				padding-top: 60px;
				transition: left 0.3s ease;
				z-index: 1100;
			}

			#sidebar.active {
				left: 0;
			}

			#sidebar a {
				color: white;
				display: block;
				padding: 12px 20px;
				text-decoration: none;
			}

			#sidebar a:hover {
				background: rgba(255, 255, 255, 0.2);
			}

			/* --- bot√£o "ver detalhes" --- */
			#botaoDetalhes {
				position: absolute;
				bottom: 20px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 1000;
			}
		</style>
	</head>

	<body>
		<div id="map"></div>

		<!-- Caixa de busca -->
		<div class="search-box">
			<input type="text" id="campoBusca" placeholder="Buscar rua..." aria-label="Buscar rua" />
			<button id="botaoBusca">üîç</button>
		</div>

		<!-- √çcones no topo -->
		<div class="top-icons">
			<button id="menuBtn">‚ò∞</button>
			<button onclick="window.location.href='login.html'">üë§</button>
		</div>

		<!-- Sidebar -->
		<div id="sidebar">
			<a href="rotas.html">Rotas</a>
			<a href="relatorio.html">Relat√≥rios</a>
			<a href="config.html">Configura√ß√µes</a>
		</div>

		<!-- Bot√£o inferior -->
		<a href="detalhes.html" id="botaoDetalhes" class="btn btn-primary btn-lg"> Ver detalhes da rua selecionada </a>

		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script>
			const map = L.map("map").setView([-23.55, -46.63], 13);
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution: "&copy; OpenStreetMap contributors",
				maxZoom: 19,
			}).addTo(map);

			let marcadorUsuario = null;
			let marcadorClique = null;
			let marcadorBusca = null;
			let ultimaSelecao = null; // <- rastreia √∫ltima a√ß√£o do usu√°rio ("auto", "clique" ou "busca")

			function salvarRuaSelecionada(nomeRua) {
				localStorage.setItem("ruaSelecionada", nomeRua);
			}

			// --- Localiza√ß√£o inicial (somente salva se o usu√°rio n√£o clicou ainda) ---
			async function localizarUsuario() {
				if (!navigator.geolocation) return;
				navigator.geolocation.getCurrentPosition(
					async (pos) => {
						const { latitude, longitude } = pos.coords;
						if (!marcadorUsuario) {
							marcadorUsuario = L.marker([latitude, longitude]).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();
						} else marcadorUsuario.setLatLng([latitude, longitude]);
						map.setView([latitude, longitude], 16);

						// reverse geocode
						const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
						try {
							const resp = await fetch(url);
							const data = await resp.json();
							if (data && data.address) {
								const nomeRua = data.address.road || data.display_name || "Local atual";
								if (!ultimaSelecao) {
									// salva s√≥ se o usu√°rio n√£o fez outra escolha
									salvarRuaSelecionada(nomeRua);
									ultimaSelecao = "auto";
								}
							}
						} catch (err) {
							console.warn("Falha no reverse geocode:", err);
						}
					},
					(err) => console.warn("Erro ao obter localiza√ß√£o:", err.message),
					{ enableHighAccuracy: true, timeout: 10000 }
				);
			}
			localizarUsuario();

			// --- clique no mapa ---
			map.on("click", async (e) => {
				const { lat, lng } = e.latlng;
				if (marcadorClique) map.removeLayer(marcadorClique);
				marcadorClique = L.marker([lat, lng]).addTo(map);
				try {
					const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
					const resp = await fetch(url);
					const data = await resp.json();
					let nomeRua = "Local desconhecido";
					if (data && data.address) {
						nomeRua = data.address.road || data.display_name || "Ponto sem nome";
					}
					salvarRuaSelecionada(nomeRua);
					ultimaSelecao = "clique"; // <- agora damos prioridade ao clique
					marcadorClique.bindPopup(`<b>${nomeRua}</b><br><a href="detalhes.html?rua=${encodeURIComponent(nomeRua)}" onclick="salvarRuaSelecionada('${nomeRua}')">Ver detalhes</a>`).openPopup();
				} catch (err) {
					marcadorClique.bindPopup("Erro ao identificar o local.").openPopup();
				}
			});

			// --- busca manual ---
			const campoBusca = document.getElementById("campoBusca");
			const botaoBusca = document.getElementById("botaoBusca");

			botaoBusca.addEventListener("click", async () => {
				const rua = campoBusca.value.trim();
				if (!rua) return alert("Digite o nome de uma rua!");

				try {
					const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(rua)}+S√£o Paulo,Brasil`;
					const resp = await fetch(url);
					const dados = await resp.json();
					if (dados.length === 0) return alert("Rua n√£o encontrada.");

					const { lat, lon, display_name } = dados[0];
					if (marcadorBusca) map.removeLayer(marcadorBusca);
					salvarRuaSelecionada(display_name);
					ultimaSelecao = "busca"; // <- prioridade para busca

					marcadorBusca = L.marker([lat, lon])
						.addTo(map)
						.bindPopup(`<b>${display_name}</b><br><a href="detalhes.html?rua=${encodeURIComponent(display_name)}" onclick="salvarRuaSelecionada('${display_name}')">Ver detalhes</a>`)
						.openPopup();
					map.setView([lat, lon], 17);
				} catch (e) {
					console.error(e);
					alert("Erro ao buscar a rua.");
				}
			});

			campoBusca.addEventListener("keypress", (e) => {
				if (e.key === "Enter") botaoBusca.click();
			});

			// --- bot√£o "ver detalhes" ---
			document.getElementById("botaoDetalhes").addEventListener("click", (e) => {
				const rua = localStorage.getItem("ruaSelecionada");
				if (rua) {
					e.preventDefault();
					window.location.href = `detalhes.html?rua=${encodeURIComponent(rua)}`;
				} else {
					alert("Nenhuma rua selecionada!");
				}
			});

			// --- sidebar ---
			const sidebar = document.getElementById("sidebar");
			document.getElementById("menuBtn").addEventListener("click", () => {
				sidebar.classList.toggle("active");
			});
		</script>
	</body>
</html>
