<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Caminho F√°cil ‚Äì Rotas</title>
		<link rel="icon" type="image/png" href="assets/img/favicon.png" />

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

		<style>
			html,
			body {
				height: 100%;
				margin: 0;
			}

			#map {
				height: 100vh;
				width: 100vw;
			}

			/* --- √≠cones superiores --- */
			.top-icons {
				position: absolute;
				top: 15px;
				right: 15px;
				z-index: 1000;
				display: flex;
				gap: 10px;
			}

			.top-icons button {
				border: none;
				background: white;
				border-radius: 50%;
				width: 42px;
				height: 42px;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
			}

			/* --- sidebar --- */
			#sidebar {
				position: fixed;
				left: -250px;
				top: 0;
				height: 100%;
				width: 250px;
				background: #198754;
				color: white;
				padding-top: 60px;
				transition: left 0.3s ease;
				z-index: 1100;
			}

			#sidebar.active {
				left: 0;
			}

			#sidebar a {
				color: white;
				display: block;
				padding: 12px 20px;
				text-decoration: none;
			}

			#sidebar a:hover {
				background: rgba(255, 255, 255, 0.2);
			}

			/* --- painel de rotas --- */
			.route-panel {
				position: absolute;
				top: 70px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 1000;
				background: white;
				padding: 15px;
				border-radius: 10px;
				width: 90%;
				max-width: 420px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
			}

			.route-panel label {
				font-weight: bold;
			}
		</style>
	</head>

	<body>
		<div id="map"></div>

		<!-- √çcones superiores -->
		<div class="top-icons">
			<button id="menuBtn">‚ò∞</button>
			<button onclick="window.location.href='login.html'">üë§</button>
		</div>

		<!-- Sidebar -->
		<div id="sidebar">
			<a href="index.html">Mapa</a>
			<a href="relatorio.html">Relat√≥rios</a>
			<a href="config.html">Configura√ß√µes</a>
		</div>

		<!-- Painel de rotas -->
		<div class="route-panel">
			<div class="mb-2">
				<label>Origem</label>
				<input type="text" id="origem" class="form-control" placeholder="Detectando sua localiza√ß√£o..." readonly />
			</div>
			<div class="mb-2">
				<label>Destino</label>
				<input type="text" id="destino" class="form-control" placeholder="Carregando destino..." readonly />
			</div>

			<div class="mb-2">
				<label>Filtros de acessibilidade</label><br />
				<div class="form-check">
					<input class="form-check-input" type="checkbox" id="cadeirante" />
					<label class="form-check-label" for="cadeirante">Adequada para cadeirantes</label>
				</div>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" id="tatil" />
					<label class="form-check-label" for="tatil">Presen√ßa de piso t√°til</label>
				</div>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" id="largas" />
					<label class="form-check-label" for="largas">Cal√ßadas largas</label>
				</div>
			</div>

			<div class="d-grid">
				<button id="btnRota" class="btn btn-primary">üö∂ Tra√ßar rota</button>
			</div>
		</div>

		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			const map = L.map("map").setView([-23.561, -46.655], 14);
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution: "&copy; OpenStreetMap contributors",
				maxZoom: 19,
			}).addTo(map);

			let origemMarker = null;
			let destinoMarker = null;
			let rota = null;
			let pontoOrigem = null;
			let pontoDestino = null;

			const campoOrigem = document.getElementById("origem");
			const campoDestino = document.getElementById("destino");

			// --- l√™ rua de destino vinda da URL ---
			const params = new URLSearchParams(window.location.search);
			const ruaDestino = params.get("rua");

			// --- fun√ß√£o para buscar coordenadas por nome ---
			async function buscarEndereco(endereco) {
				const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}+S√£o Paulo,Brasil`;
				const resp = await fetch(url);
				const dados = await resp.json();
				return dados.length ? dados[0] : null;
			}

			// --- obt√©m localiza√ß√£o atual automaticamente ---
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(pos) => {
						const { latitude, longitude } = pos.coords;
						pontoOrigem = L.latLng(latitude, longitude);
						map.setView(pontoOrigem, 15);
						origemMarker = L.marker(pontoOrigem).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();
						campoOrigem.value = "Minha localiza√ß√£o atual";
					},
					(err) => console.warn("Erro ao obter localiza√ß√£o:", err.message),
					{ enableHighAccuracy: true, timeout: 10000 }
				);
			}

			// --- carrega destino automaticamente se veio de detalhes ---
			if (ruaDestino) {
				campoDestino.value = decodeURIComponent(ruaDestino);
				buscarEndereco(ruaDestino).then((d) => {
					if (d) {
						pontoDestino = L.latLng(d.lat, d.lon);
						destinoMarker = L.marker(pontoDestino)
							.addTo(map)
							.bindPopup(`Destino: ${decodeURIComponent(ruaDestino)}`)
							.openPopup();
					}
				});
			} else {
				campoOrigem.placeholder = "Digite o endere√ßo de origem...";
				campoDestino.placeholder = "Digite o endere√ßo de destino...";
			}

			// --- sempre edit√°vel ---
			campoOrigem.removeAttribute("readonly");
			campoDestino.removeAttribute("readonly");

			// --- tra√ßar rota manualmente ---
			document.getElementById("btnRota").addEventListener("click", async () => {
				let origemTxt = campoOrigem.value.trim();
				let destinoTxt = campoDestino.value.trim();

				if (!origemTxt || !destinoTxt) {
					alert("Preencha ambos os endere√ßos!");
					return;
				}

				let o = null;
				let d = null;

				// üëâ Se o usu√°rio deixou ‚ÄúMinha localiza√ß√£o atual‚Äù, usa as coordenadas do GPS
				if (origemTxt.toLowerCase().includes("minha localiza√ß√£o") && pontoOrigem) {
					o = { lat: pontoOrigem.lat, lon: pontoOrigem.lng };
				} else {
					o = await buscarEndereco(origemTxt);
				}

				d = await buscarEndereco(destinoTxt);

				if (!o || !d) {
					alert("N√£o foi poss√≠vel localizar um dos endere√ßos.");
					return;
				}

				pontoOrigem = L.latLng(o.lat, o.lon);
				pontoDestino = L.latLng(d.lat, d.lon);

				if (origemMarker) map.removeLayer(origemMarker);
				if (destinoMarker) map.removeLayer(destinoMarker);

				origemMarker = L.marker(pontoOrigem).addTo(map).bindPopup("Origem");
				destinoMarker = L.marker(pontoDestino).addTo(map).bindPopup("Destino");

				if (rota) map.removeLayer(rota);
				rota = L.polyline([pontoOrigem, pontoDestino], {
					color: "blue",
					weight: 4,
				}).addTo(map);
				map.fitBounds(rota.getBounds());
			});

			// --- sidebar ---
			const sidebar = document.getElementById("sidebar");
			document.getElementById("menuBtn").addEventListener("click", () => {
				sidebar.classList.toggle("active");
			});
		</script>
	</body>
</html>
