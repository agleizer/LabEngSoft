<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Caminho F√°cil ‚Äì Relat√≥rio</title>
		<link rel="icon" type="image/png" href="assets/img/favicon.png" />

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

		<style>
			html,
			body {
				height: 100%;
				margin: 0;
			}

			#map {
				height: 100vh;
				width: 100vw;
			}

			/* --- barra de busca --- */
			.search-box {
				position: absolute;
				top: 15px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 1000;
				width: 90%;
				max-width: 500px;
				background: white;
				border-radius: 8px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
				display: flex;
			}

			.search-box input {
				border: none;
				padding: 10px;
				flex: 1;
				border-radius: 8px 0 0 8px;
			}

			.search-box button {
				border: none;
				background: #198754;
				color: white;
				padding: 0 15px;
				border-radius: 0 8px 8px 0;
			}

			/* --- √≠cones no topo --- */
			.top-icons {
				position: absolute;
				top: 15px;
				right: 15px;
				z-index: 1000;
				display: flex;
				gap: 10px;
			}

			.top-icons button {
				border: none;
				background: white;
				border-radius: 50%;
				width: 42px;
				height: 42px;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
			}

			/* --- sidebar lateral --- */
			#sidebar {
				position: fixed;
				left: -250px;
				top: 0;
				height: 100%;
				width: 250px;
				background: #198754;
				color: white;
				padding-top: 60px;
				transition: left 0.3s ease;
				z-index: 1100;
			}

			#sidebar.active {
				left: 0;
			}

			#sidebar a {
				color: white;
				display: block;
				padding: 12px 20px;
				text-decoration: none;
			}

			#sidebar a:hover {
				background: rgba(255, 255, 255, 0.2);
			}

			/* --- controle de raio --- */
			.radius-control {
				position: absolute;
				bottom: 110px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 1000;
				background: white;
				padding: 10px 15px;
				border-radius: 10px;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
				text-align: center;
				width: 300px;
			}

			/* --- bot√£o gerar relat√≥rio --- */
			#btnRelatorio {
				position: absolute;
				bottom: 30px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 1000;
			}

			/* --- ajustes mobile --- */
			@media (max-width: 768px) {
				.search-box {
					top: 65px;
					left: 5%;
					transform: none;
					width: 90%;
					max-width: none;
				}
				.leaflet-top.leaflet-left {
					top: 140px; /* empurra os bot√µes + e - para baixo */
				}
			}

			#botaoBusca:hover{
				background-color: #5bce98;
			}

			#botaoBusca:active{
				background-color: #0b3723;
			}
		</style>
	</head>

	<body>
		<div id="map"></div>

		<!-- Caixa de busca -->
		<div class="search-box">
			<input type="text" id="campoBusca" placeholder="Buscar endere√ßo..." aria-label="Buscar endere√ßo" />
			<button id="botaoBusca">
				<img src="assets/img/lupa.png" style="width: 15px; padding-bottom: 3px;">
			</button>
		</div>

		<!-- √çcones superiores -->
		<div class="top-icons">
			<button id="menuBtn">‚ò∞</button>
			<button onclick="window.location.href='login.html'">üë§</button>
		</div>

		<!-- Sidebar lateral -->
		<div id="sidebar">
			<a href="index.html">Mapa</a>
			<a href="rotas.html">Rotas</a>
			<a href="config.html">Configura√ß√µes</a>
		</div>

		<!-- Controle de raio -->
		<div class="radius-control">
			<label for="raio" class="form-label fw-bold">Raio de an√°lise</label>
			<input type="range" class="form-range" min="100" max="1000" step="100" id="raio" value="500" />
			<p class="mb-0">Raio atual: <span id="valorRaio">500</span> m</p>
		</div>

		<!-- Bot√£o gerar relat√≥rio -->
		<button id="btnRelatorio" class="btn btn-primary btn-lg">
			<img src="assets/img/download.png" style="width: 15px; padding-bottom: 3px; display: inline-block">
			Gerar Relat√≥rio
		</button>

		<!-- Modal de sucesso -->
		<div class="modal fade" id="modalSucesso" tabindex="-1" aria-labelledby="modalSucessoLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content border-success">
					<div class="modal-header bg-success text-white">
						<h5 class="modal-title" id="modalSucessoLabel">Relat√≥rio Gerado!</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body text-center">
						<p>O relat√≥rio foi gerado com sucesso e o download iniciou automaticamente.</p>
						<p>Arquivo: <strong>relatorio_caminho_facil.csv</strong></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-success" data-bs-dismiss="modal">Fechar</button>
					</div>
				</div>
			</div>
		</div>

		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			const map = L.map("map").setView([-23.55, -46.63], 13);
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution: "&copy; OpenStreetMap contributors",
				maxZoom: 19,
			}).addTo(map);

			let marcador = null;
			let circulo = null;

			const inputRaio = document.getElementById("raio");
			const textoRaio = document.getElementById("valorRaio");
			const campoBusca = document.getElementById("campoBusca");
			const botaoBusca = document.getElementById("botaoBusca");

			// --- localiza√ß√£o inicial ---
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition((pos) => {
					const { latitude, longitude } = pos.coords;
					map.setView([latitude, longitude], 15);
					marcador = L.marker([latitude, longitude]).addTo(map);
					circulo = L.circle([latitude, longitude], {
						radius: 500,
						color: "green",
						fillOpacity: 0.2,
					}).addTo(map);
				});
			}

			// --- clique no mapa ---
			map.on("click", (e) => {
				const { lat, lng } = e.latlng;
				if (marcador) map.removeLayer(marcador);
				if (circulo) map.removeLayer(circulo);

				marcador = L.marker([lat, lng]).addTo(map).bindPopup("Ponto selecionado").openPopup();
				circulo = L.circle([lat, lng], {
					radius: parseInt(inputRaio.value),
					color: "green",
					fillOpacity: 0.2,
				}).addTo(map);
			});

			// --- busca de endere√ßo ---
			botaoBusca.addEventListener("click", async () => {
				const endereco = campoBusca.value.trim();
				if (!endereco) return alert("Digite um endere√ßo!");

				try {
					const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}+S√£o Paulo,Brasil`;
					const resp = await fetch(url);
					const dados = await resp.json();

					if (dados.length === 0) return alert("Endere√ßo n√£o encontrado.");

					const { lat, lon, display_name } = dados[0];
					if (marcador) map.removeLayer(marcador);
					if (circulo) map.removeLayer(circulo);

					marcador = L.marker([lat, lon]).addTo(map).bindPopup(`<b>${display_name}</b>`).openPopup();

					circulo = L.circle([lat, lon], {
						radius: parseInt(inputRaio.value),
						color: "green",
						fillOpacity: 0.2,
					}).addTo(map);

					map.setView([lat, lon], 16);
				} catch (e) {
					alert("Erro ao buscar o endere√ßo.");
				}
			});

			campoBusca.addEventListener("keypress", (e) => {
				if (e.key === "Enter") botaoBusca.click();
			});

			// --- ajuste de raio ---
			inputRaio.addEventListener("input", () => {
				const r = parseInt(inputRaio.value);
				textoRaio.textContent = r;
				if (circulo) circulo.setRadius(r);
			});

			// --- bot√£o gerar relat√≥rio ---
			document.getElementById("btnRelatorio").addEventListener("click", () => {
				const csv = "Rua,Nota m√©dia,Observa√ß√µes\n" + "Rua XV de Novembro,4.2,Boa acessibilidade\n" + "Avenida Paulista,4.6,Ilumina√ß√£o adequada\n" + "Rua Augusta,3.8,Desn√≠veis pontuais";

				const blob = new Blob([csv], { type: "text/csv" });
				const url = URL.createObjectURL(blob);
				const a = document.createElement("a");
				a.href = url;
				a.download = "relatorio_caminho_facil.csv";
				a.click();
				URL.revokeObjectURL(url);

				const modal = new bootstrap.Modal(document.getElementById("modalSucesso"));
				modal.show();
			});

			// --- menu lateral ---
			const sidebar = document.getElementById("sidebar");
			document.getElementById("menuBtn").addEventListener("click", () => {
				sidebar.classList.toggle("active");
			});
		</script>
	</body>
</html>
