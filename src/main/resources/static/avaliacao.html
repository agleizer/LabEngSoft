<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Caminho Fácil - Avaliação</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

		<style>
			body {
				background-color: #f8f9fa;
			}

			/* estrelas */
			.star-rating {
				display: flex;
				gap: 5px;
				font-size: 2rem;
				color: #ccc;
				cursor: pointer;
				justify-content: center;
			}
			.star.active {
				color: gold;
			}

			/* switches */
			.form-switch {
				background: white;
				border-radius: 10px;
				padding: 10px 15px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
				margin-bottom: 8px;
			}

			.alert {
				display: none;
			}

			.logoBox {
				background-color: white;
				border-radius: 0 8px 8px 0;
				padding: 5px 10px;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
				display: inline-block;
			}

			.logoImg {
				height: 30px;
				display: block;
			}

			.navbar {
				padding-top: 0.5rem;
				padding-bottom: 0.5rem;
			}
		</style>
	</head>

	<link rel="icon" type="image/png" href="assets/img/favicon.png" />

	<body>
		<nav class="navbar navbar-dark bg-success fixed-top position-relative">
			<div class="container-fluid d-flex align-items-center justify-content-between">
				<a id="btnVoltar" class="navbar-brand text-white ms-5" href="#" style="padding-left: 50px">← Voltar</a>
				<span class="navbar-text text-white me-3">Avaliar Calçada</span>
			</div>

			<!-- Logo placed *below* the navbar, but visually overlapping -->
			<div class="logoBox position-absolute" style="top: 100%; left: 0; transform: translateY(-40%); z-index: 1">
				<img class="logoImg" src="assets/img/logoCF.png" alt="Logo Caminho Fácil" />
			</div>
		</nav>

		<div class="container mt-5 pt-4">
			<form id="avaliacaoForm">
				<!-- Estrelas -->
				<div class="mb-4 text-center">
					<div id="stars" class="star-rating">
						<span class="star" data-value="1">★</span>
						<span class="star" data-value="2">★</span>
						<span class="star" data-value="3">★</span>
						<span class="star" data-value="4">★</span>
						<span class="star" data-value="5">★</span>
					</div>
					<input type="hidden" id="nota" value="0" />
				</div>

				<!-- Comentário -->
				<div class="mb-3">
					<label class="form-label fw-bold">Comentário</label>
					<textarea id="comentario" class="form-control" rows="3" placeholder="Escreva aqui seu comentário..."></textarea>
				</div>

				<!-- Detalhes -->
				<div class="mb-4">
					<label class="form-label fw-bold">Detalhes</label>

					<div class="form-switch">
						<label for="cadeirante">Adequado para cadeira de rodas?</label>
						<input class="form-check-input" type="checkbox" id="cadeirante" checked />
					</div>

					<div class="form-switch">
						<label for="bebe">Adequado para carrinhos de bebê?</label>
						<input class="form-check-input" type="checkbox" id="bebe" checked />
					</div>

					<div class="form-switch">
						<label for="idosos">Adequado para idosos?</label>
						<input class="form-check-input" type="checkbox" id="idosos" checked />
					</div>

					<div class="form-switch">
						<label for="tatil">Presença de piso tátil</label>
						<input class="form-check-input" type="checkbox" id="tatil" checked />
					</div>

					<div class="form-switch">
						<label for="rebaixamento">Rebaixamento de guia</label>
						<input class="form-check-input" type="checkbox" id="rebaixamento" checked />
					</div>

					<div class="form-switch">
						<label for="obstaculos">Calçada livre de obstáculos</label>
						<input class="form-check-input" type="checkbox" id="obstaculos" checked />
					</div>

					<div class="form-switch">
						<label for="iluminacao">Iluminação noturna</label>
						<input class="form-check-input" type="checkbox" id="iluminacao" checked />
					</div>
				</div>

				<!-- Foto -->
				<div class="mb-3">
					<label class="form-label fw-bold">Foto (opcional)</label>
					<input type="file" class="form-control" id="foto" />
				</div>

				<!-- Alertas -->
				<div class="alert alert-danger" id="alertErro">⚠️ Preencha a nota e o comentário antes de enviar.</div>
				<div class="alert alert-success text-center" id="alertSucesso">
					✅ Avaliação enviada com sucesso! <br />
					<button type="button" id="btnVoltarSucesso" class="btn btn-outline-success mt-2">Voltar aos detalhes</button>
				</div>

				<!-- Botão Enviar -->
				<div class="d-grid mt-4">
					<button type="submit" class="btn btn-primary">Enviar avaliação</button>
				</div>
			</form>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<!-- atualiza botoes de voltar dinamicamente -->
		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const rua = localStorage.getItem("ruaSelecionada");

				const btnVoltar = document.getElementById("btnVoltar");
				if (btnVoltar) {
					btnVoltar.href = rua ? `detalhes.html?rua=${encodeURIComponent(rua)}` : "index.html";
				}

				const btnVoltarSucesso = document.getElementById("btnVoltarSucesso");
				if (btnVoltarSucesso) {
					btnVoltarSucesso.addEventListener("click", () => {
						window.location.href = rua ? `detalhes.html?rua=${encodeURIComponent(rua)}` : "index.html";
					});
				}
			});
		</script>

		<script>
			const stars = document.querySelectorAll(".star");
			const notaInput = document.getElementById("nota");
			const alertErro = document.getElementById("alertErro");
			const alertSucesso = document.getElementById("alertSucesso");
			const form = document.getElementById("avaliacaoForm");

			// controle de estrelas
			stars.forEach((star) => {
				star.addEventListener("click", () => {
					const value = parseInt(star.dataset.value);
					notaInput.value = value;
					stars.forEach((s) => {
						s.classList.toggle("active", parseInt(s.dataset.value) <= value);
					});
				});
			});

			// envio real da avaliação
			form.addEventListener("submit", async (e) => {
				e.preventDefault();
				alertErro.style.display = "none";
				alertSucesso.style.display = "none";

				const nota = parseInt(notaInput.value);
				const comentario = document.getElementById("comentario").value.trim();
				const rua = localStorage.getItem("ruaSelecionada") || "Desconhecida";

				if (!nota || !comentario) {
					alertErro.style.display = "block";
					return;
				}

				// coleta completa — incluindo coordenadas salvas no localStorage
				const dados = {
					rua,
					notaGeral: nota,
					notaCadeirante: document.getElementById("cadeirante").checked ? 5 : 3,
					notaCarrinho: document.getElementById("bebe").checked ? 5 : 3,
					notaIdoso: document.getElementById("idosos").checked ? 5 : 3,
					notaCego: document.getElementById("tatil").checked ? 5 : 3,
					presencaPisoTatil: document.getElementById("tatil").checked,
					rebaixamentoGuia: document.getElementById("rebaixamento").checked,
					semObstaculos: document.getElementById("obstaculos").checked,
					iluminacaoNoturna: document.getElementById("iluminacao").checked,
					comentario: comentario,
					latitudeIni: parseFloat(localStorage.getItem("latIni")) || 0,
					longitudeIni: parseFloat(localStorage.getItem("lonIni")) || 0,
					latitudeFim: parseFloat(localStorage.getItem("latFim")) || 0,
					longitudeFim: parseFloat(localStorage.getItem("lonFim")) || 0,
				};

				try {
					const resp = await fetch("/api/avaliacoes", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(dados),
					});

					if (!resp.ok) throw new Error("Falha no envio");
					alertSucesso.style.display = "block";
					window.scrollTo({ top: 0, behavior: "smooth" });
					form.reset();
					stars.forEach((s) => s.classList.remove("active"));
					notaInput.value = 0;
				} catch (err) {
					console.error(err);
					alertErro.textContent = "❌ Erro ao enviar avaliação. Tente novamente.";
					alertErro.style.display = "block";
				}
			});
		</script>
	</body>
</html>
